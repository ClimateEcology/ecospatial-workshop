---
title: "EcoSpatial Workshop"
author: "Heather Grab, Kevin Li, Sarah Goslee"
date: "2024-10-03"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", warning = FALSE, message = FALSE)
```

# Workshop Outline {-}

This workshop is designed to introduce users to the new [**beeshiny app**](https://beesuite.psu.edu/beeshiny/). 

beeshiny can be used to query data commonly used when modeling the environemental drivers of species' or commmunity responses. beeshiny was originally build as a companion to [Beescape](https://beescape.psu.edu/). 

beeshiny allows users to extract:

* climate data: monthly precipitation, min, and max temperature from PRISM
* crop land covers: from the NASS CropLand Data Layer
* beescape indices: spring forage, summer forage, fall forage, nesting, and pesticides

## Nomenclature

* **raster:** A form of geographic data that represents the landscape as a grid of cells. Grid values can be continuous values, signifying things like elevation, temperature, or spectral information (e.g. color) in a satellite image; or categorical values, signifying thematic classes like land cover.
* **vector:** Another form of geographic data that represents specific features on the landscape composed of discrete geometric locations that consist of x and y values. These can be points, lines, or polygons.
* **Cropland Data Layer (CDL):** A set of raster datasets produced by the USDA Nationa Agricultural Statistics (NASS) Service and Agricultural Research Service (ARS) that represents annual crop-specific land cover produced from satellite imagery and ground reference data.

## Data Details

We will use data downloaded from the [**beeshiny app**](https://beesuite.psu.edu/beeshiny/), along with point data representing hypothetical sites in Centre County, PA, which can be downloaded from this repository in the `/data`` folder.

 * *Note that if you are unable to access the data on beeshiny, backup data are available in the repository in* `data/backups`

## Load packages

There are a number of packages in R that are helpful in working with spatial data. For this workshop we will be using `sf` and `terra`. 
For data wrangling and visualizations we will use `dplyr`, `ggplot2` and `tidyterra`. 

| Name | Description | Link |
|:--|:--|:--|
| `dplyr` | Package that provides a 'grammar' of data manipulation in `R` | https://dplyr.tidyverse.org/ |
| `ggplot2` | Package that provides a system for declaratively creating graphics | https://ggplot2.tidyverse.org/ |
| `sf` | Package for manipulating 2-D geographic vector data | https://r-spatial.github.io/sf/ |
| `terra` | Package for spatial data analysis | https://rspatial.github.io/terra/ |
| `tidyterra` | Package for integrating objects from `terra` with the `dplyr` and `ggplot2` packages | https://dieghernan.github.io/tidyterra/ |

Because some spatial functions have the same names as dplyr functions it is helpful to load the spatial packages last. We can also use the `::` to specify the package for function calls. 

Unhash and use install.packages for any packages your may not already have installed

```{r packages, echo=TRUE, results='hide', message=FALSE}
library(dplyr)
library(ggplot2)
#install.packages("sf", dependencies = TRUE)
#install.packages("terra", dependencies = TRUE)
#install.packages("tidyterra", dependencies = TRUE)
library(sf)
library(terra)
library(tidyterra)
```

# Working with raster data in R

## Get raster data from beeshiny

Use [**beeshiny**](https://beesuite.psu.edu/beeshiny/) to download a CDL raster for any county in the US you would like for any year you want

## Read in raster data

Downloaded data from beeshiny is packaged as a zipped file called data.zip. Inside this file you should have a .tif file. The name indicates the data type, in this case CDL, the year and the FIPS code that corresponds to the county you selected. 

Move the .tif file into the /data folder in your ecospatial-workshop directory

The first thing we will do is use the `rast()` function to read the .tif file into R as a SpatRaster. NOTE: your CDL file may have a different year and a different number after the FIPS code. 

```{r create SpatRaster of cdl}
county_cdl <- rast("data/CDL_2021_FIPS_42027.tif") # <- replace the .tif file with your file name

county_cdl
```
 
An important attribute of spatial data are their Coordinate Reference System or CRS. This information tells us what model of the earth (ex WGS84 or NAD83) is being referenced as well as the units of the coordinates such as decimal degrees. 

Rasters downloaded from beeshiny inherit their CRS from the raster they were originally extracted from. 

Let's view the CRS for your county cdl:

```{r crs}
crs(county_cdl)
```

We can see that our CDL raster is using the North American Datum of 1983 as it's model for the shape of the earth. Our two-dimensional projection model of earth's 3d surface is Alber's Equal Area and the units of our coordinates are in meters. 


## Visualize raster data

We can visualize our county CDl raster using either base R plotting and terra 

```{r base}
plot(county_cdl)
```

or using ggplot2 and tidyterra

```{r ggplot}
ggplot() +
  geom_spatraster(data = county_cdl, aes(fill = Class_Names)) 
```


## Reclass raster values

We can reclassify the CDL raster giving it the proper land cover names and turning it into a map of floral resources using the values from [Koh et al. 2015](https://www.pnas.org/doi/abs/10.1073/pnas.1517685113). 

The table contains each CDL value, it's corresponding class name and the values for several indices. 

```{r read in koh table}
reclass_table <- read.csv("data/cdl_reclass_koh.csv")
head(reclass_table)
```

We can see from our plots that the CDL Class Names are stored as numeric values, these have no numeric meaning. They simply correspond to a land cover class. 
 
The values can be reclassified into their class names or into other values using the `classify()` function. 

### Reclass to named CDL classes

We can also reclassify the CDL to show it's land class names rather than the values. In this case we will use a different work flow by modifying the levels. 

First we set the levels of the raster to the land cover class names using the first two columns of our reclass table

```{r relevel}
levels(county_cdl) <- as.data.frame(reclass_table[,1:2])
```

Then we can even recolor the classes to match the traditional NASS CDL style.

First, we will load in a file with which describes the color values associated with each CDL value.

```{r load colormap}
cdl_colormap <- read.csv("data/cdl_colormap.csv")
cdl_colormap
```

Then we can assign the color values to their corresponding levels in the raster and view a plot to check it out. 
```{r }
terra::coltab(county_cdl) <- cdl_colormap

ggplot() +
  geom_spatraster(data = county_cdl, aes(fill = CLASS_NAME))

```

The legend is now quite large but can be easily modified using ggplot2 themes functions

```{r}
ggplot() +
  geom_spatraster(data = county_cdl, aes(fill = CLASS_NAME)) +
  theme(legend.title = element_text(size = 7), 
        legend.text = element_text(size = 7), 
        legend.key.size = unit(0.25, 'cm'),
        legend.position="bottom") 
```


### Reclass to spring floral resources map

We will select just the columns corresponding to the CDL value and the spring floral resources to reclassify our county CDL and generate a map of spring floral resources across the county

```{r reclass to forage}
county_floral_sp <- classify(county_cdl,
                    reclass_table[,c("Class_Names",
                                     "floral_resources_spring_index")])

plot(county_floral_sp)
```

## Inspect raster values

Using the `values()` function we can inspect the distribution of spring floral values for your county. We will set the `na.rm=TRUE` argument so that all the cells outside of the county are not included

```{r inspect cdl, warning=FALSE}
summary(values(county_floral_sp, na.rm=TRUE))
hist(values(county_floral_sp, na.rm=TRUE))
```

and look at at individual grid cell values. In this case we, will only extract the first 20 grid cell values.
```{r inspect values}
values(county_floral_sp, na.rm=TRUE)[1:20]
```



## Check your learning

1. Use beeshiny to download the CDL raster for Centre County Pa for any year you want

2. Move the CDL raster for Centre County to the /data folder in your ecospatial-workshop directory

3. Read the raster into R as a terra SpatRaster

4. Replace the CDL value codes with the land cover class names
```{r check learning raster, class.source = 'fold-hide', message=FALSE}
centre_cdl <- rast("data/CDL_2021_FIPS_42027.tif") 

#OR if beeshiny not working:

centre_cdl <- rast("data/backups/pa_centre_cdl_2021.tif") 
levels(centre_cdl) <- as.data.frame(reclass_table[,1:2])
terra::coltab(centre_cdl) <- as.data.frame(cdl_colormap)
#plot(centre_cdl)

```



# Working with point data

## Read in point data

```{r read in pts}
centre_sites <- read.csv("data/centre_co_pts.csv")
centre_sites <- st_as_sf(centre_sites, coords=c("Long","Lat"), 
                         crs = 4326) #set the crs
centre_sites
```


## Visualize point data
```{r}
ggplot()+
  geom_spatraster(data = centre_cdl, aes(fill = CLASS_NAME)) +
  geom_sf(data=centre_sites) + 
  theme(legend.title = element_text(size = 7), 
        legend.text = element_text(size = 7), 
        legend.key.size = unit(0.25, 'cm'),
        legend.position="bottom") 
```

## Buffer around points

```{r}
centre_sites_1000m <- st_buffer(centre_sites, 1000)
```

```{r}
ggplot()+
  geom_spatraster(data = centre_cdl, aes(fill = CLASS_NAME)) +
  geom_sf(data = centre_sites_1000m)+
  geom_sf(data=centre_sites) + 
  theme(legend.title = element_text(size = 7), 
        legend.text = element_text(size = 7), 
        legend.key.size = unit(0.25, 'cm'),
        legend.position="bottom") 
```


## Extract CDL values within buffers
```{r}
centre_table_1000m <- extract(centre_cdl, centre_sites_1000m, fun="table", ID=F)
centre_table_1000m
```

```{r}
Area_m2 <- rowSums(centre_table_1000m)*900
centre_table_1000m_prop <- centre_table_1000m/rowSums(centre_table_1000m)

centre_table_1000m_prop <- cbind(Area_m2,centre_table_1000m_prop)
```


## Check your learning

1. Using beeshiny, extract the CDL values for 1km around the centre county points for the same year of the CDL that you used in the last activity. 

# Working with climate data

```{r}

```

# Bringing it all together
```{r}

```

